# ğŸ—ï¸ LeadPilot System Architecture

---

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LEADPILOT CRM SYSTEM                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Meta Ads API   â”‚    â”‚ Google Ads API   â”‚    â”‚  WhatsApp API    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚           â”‚                       â”‚                       â”‚                  â”‚
â”‚           â”‚        WEBHOOK        â”‚        WEBHOOK        â”‚                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                       â”‚                       â”‚                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜                              â”‚
â”‚              â”‚                              â”‚                                â”‚
â”‚         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                          â”‚
â”‚         â”‚ Webhook       â”‚        â”‚ WhatsApp      â”‚                          â”‚
â”‚         â”‚ Receiver      â”‚        â”‚ Webhook       â”‚                          â”‚
â”‚         â”‚ (Edge Fn)     â”‚        â”‚ (Edge Fn)     â”‚                          â”‚
â”‚         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                          â”‚
â”‚              â”‚                              â”‚                                â”‚
â”‚              â”‚        VERIFY + ROUTE        â”‚                                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                             â”‚                                                â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                    â”‚  Supabase Edge   â”‚                                      â”‚
â”‚                    â”‚  Functions       â”‚                                      â”‚
â”‚                    â”‚  (Deno Runtime)  â”‚                                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                             â”‚                                                â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚              â”‚              â”‚              â”‚                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â–¼â”€â”€â”€â”                              â”‚
â”‚         â”‚ Insert  â”‚   â”‚ Dedupe    â”‚   â”‚ Send â”‚                              â”‚
â”‚         â”‚ Lead    â”‚   â”‚ Check     â”‚   â”‚ Auto â”‚                              â”‚
â”‚         â”‚ to CRM  â”‚   â”‚           â”‚   â”‚ Resp â”‚                              â”‚
â”‚         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”¬â”€â”€â”€â”˜                              â”‚
â”‚              â”‚              â”‚             â”‚                                  â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                             â”‚                                                â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚                â”‚                          â”‚                                  â”‚
â”‚                â”‚   SUPABASE PostgreSQL    â”‚                                  â”‚
â”‚                â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                  â”‚
â”‚                â”‚   â”‚ Leads              â”‚ â”‚                                  â”‚
â”‚                â”‚   â”‚ Contacts           â”‚ â”‚                                  â”‚
â”‚                â”‚   â”‚ Meta Ads Leads     â”‚ â”‚                                  â”‚
â”‚                â”‚   â”‚ Google Ads Leads   â”‚ â”‚                                  â”‚
â”‚                â”‚   â”‚ WhatsApp Conv.     â”‚ â”‚                                  â”‚
â”‚                â”‚   â”‚ WhatsApp Messages  â”‚ â”‚                                  â”‚
â”‚                â”‚   â”‚ Webhook Logs       â”‚ â”‚                                  â”‚
â”‚                â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                  â”‚
â”‚                â”‚                          â”‚                                  â”‚
â”‚                â”‚   RLS Security Policies  â”‚                                  â”‚
â”‚                â”‚   PostgREST API          â”‚                                  â”‚
â”‚                â”‚   Real-time Subscriptionsâ”‚                                  â”‚
â”‚                â”‚                          â”‚                                  â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                         â”‚                                                    â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚        â”‚                â”‚                â”‚                                   â”‚
â”‚    â”Œâ”€â”€â”€â–¼â”€â”€â”        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚    â”‚ Reactâ”‚        â”‚Dashboard â”‚      â”‚ Webhook â”‚                            â”‚
â”‚    â”‚ App  â”‚        â”‚ Views    â”‚      â”‚ Config  â”‚                            â”‚
â”‚    â”‚      â”‚        â”‚          â”‚      â”‚         â”‚                            â”‚
â”‚    â”‚â”Œâ”€â”€â”€â”€â”â”‚        â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚      â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”‚                            â”‚
â”‚    â”‚â”‚Metaâ”‚         â”‚â”‚Leads   â”‚       â”‚â”‚Manage â”‚â”‚                            â”‚
â”‚    â”‚â”‚Ads â”‚â”‚        â”‚â”‚Capture â”‚       â”‚â”‚Events â”‚â”‚                            â”‚
â”‚    â”‚â””â”€â”€â”€â”€â”˜â”‚        â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚      â”‚â””â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                            â”‚
â”‚    â”‚      â”‚        â”‚          â”‚      â”‚         â”‚                            â”‚
â”‚    â”‚â”Œâ”€â”€â”€â”€â”â”‚        â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚      â”‚         â”‚                            â”‚
â”‚    â”‚â”‚Googâ”‚â”‚        â”‚â”‚WhatsAppâ”‚â”‚      â”‚         â”‚                            â”‚
â”‚    â”‚â”‚Ads â”‚â”‚        â”‚â”‚Chat    â”‚â”‚      â”‚         â”‚                            â”‚
â”‚    â”‚â””â”€â”€â”€â”€â”˜â”‚        â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚      â”‚         â”‚                            â”‚
â”‚    â”‚      â”‚        â”‚          â”‚      â”‚         â”‚                            â”‚
â”‚    â”‚â”Œâ”€â”€â”€â”€â”â”‚        â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚      â”‚         â”‚                            â”‚
â”‚    â”‚â”‚Chatâ”‚â”‚        â”‚â”‚Settingsâ”‚â”‚      â”‚         â”‚                            â”‚
â”‚    â”‚â””â”€â”€â”€â”€â”˜â”‚        â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚      â”‚         â”‚                            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚      â”‚                 â”‚                 â”‚                                   â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                        â”‚                                                     â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚                 â”‚ Vite + React â”‚                                             â”‚
â”‚                 â”‚ TypeScript   â”‚                                             â”‚
â”‚                 â”‚ Tailwind CSS â”‚                                             â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                        â”‚                                                     â”‚
â”‚                  (Browser/Desktop)                                            â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow: Lead Capture

```
META ADS / GOOGLE ADS              WHATSAPP
    â”‚                                  â”‚
    â”‚ Lead Form Submission             â”‚ Incoming Message
    â”‚                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ POST to Webhook URL
               â”‚ /api/webhooks/{source}
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Edge Function  â”‚
        â”‚ webhook-       â”‚
        â”‚ receiver       â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 1. Verify Signature (HMAC)  â”‚
        â”‚ 2. Check Rate Limits        â”‚
        â”‚ 3. Route to Handler         â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                â”‚              â”‚
    â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Meta Handlerâ”‚  â”‚Google      â”‚  â”‚WhatsApp   â”‚
    â”‚             â”‚  â”‚Handler     â”‚  â”‚Handler    â”‚
    â”‚ - Parse     â”‚  â”‚            â”‚  â”‚           â”‚
    â”‚ - Check Dup â”‚  â”‚ - Parse    â”‚  â”‚ - Create  â”‚
    â”‚ - Create    â”‚  â”‚ - Check Dupâ”‚  â”‚   Conv    â”‚
    â”‚   Lead      â”‚  â”‚ - Create   â”‚  â”‚ - Log Msg â”‚
    â”‚             â”‚  â”‚   Lead     â”‚  â”‚ - Auto    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚   Reply   â”‚
           â”‚                â”‚        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ Check Existing  â”‚
           â”‚ Contact/Lead    â”‚
           â”‚ by Email/Phone  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                        â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ Exists â”‚            â”‚ Not Exists â”‚
    â”‚ (Dupe) â”‚            â”‚ (New)      â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                        â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ Skip or    â”‚          â”‚ Insert    â”‚
    â”‚ Link to    â”‚          â”‚ New Lead  â”‚
    â”‚ Existing   â”‚          â”‚ to CRM    â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Store Metadataâ”‚
          â”‚ (source lead â”‚
          â”‚  ID, campaign)â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Insert into       â”‚
          â”‚ meta_ads_leads /  â”‚
          â”‚ google_ads_leads/ â”‚
          â”‚ whatsapp_messages â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Update Dashboard â”‚
        â”‚ Real-time via    â”‚
        â”‚ Subscriptions    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow: WhatsApp Communication

```
INCOMING MESSAGE                      OUTBOUND MESSAGE
    â”‚                                      â”‚
    â”‚ Customer sends message               â”‚ Agent sends message
    â”‚ on WhatsApp                          â”‚ in chat UI
    â”‚                                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ WhatsApp        â”‚
    â”‚ Webhook         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Parse Message         â”‚
    â”‚ Extract Phone Number  â”‚
    â”‚ Extract Message Text  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Find/Create Contact     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Find/Create Conversation     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Store Message to DB       â”‚
    â”‚ whatsapp_messages table   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Check auto_response      â”‚
    â”‚ enabled setting          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚ Send    â”‚
        â”‚ Auto    â”‚
        â”‚ Reply   â”‚ â”€â”€â†’ Send via WhatsApp API
        â”‚         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Update React UI   â”‚
    â”‚ Real-time via     â”‚
    â”‚ Subscriptions     â”‚
    â”‚ Show in Chat      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Schema: Phase 1 (Webhooks)

```
webhooks
â”œâ”€â”€ id (uuid, PK)
â”œâ”€â”€ webhook_source_id (uuid, FK â†’ webhook_sources)
â”œâ”€â”€ status ('success', 'pending', 'failed')
â”œâ”€â”€ raw_payload (jsonb)
â”œâ”€â”€ signature_verified (boolean)
â”œâ”€â”€ error_message (text)
â””â”€â”€ created_at, updated_at

webhook_logs
â”œâ”€â”€ id (uuid, PK)
â”œâ”€â”€ webhook_id (uuid, FK â†’ webhooks)
â”œâ”€â”€ status ('sent', 'delivered', 'failed')
â”œâ”€â”€ response_body (text)
â”œâ”€â”€ error_message (text)
â””â”€â”€ created_at

webhook_sources
â”œâ”€â”€ id (uuid, PK)
â”œâ”€â”€ name (varchar)
â”œâ”€â”€ secret_key (encrypted)
â”œâ”€â”€ active (boolean)
â””â”€â”€ created_at
```

---

## Database Schema: Phase 2 (Meta Ads)

```
meta_ads_leads
â”œâ”€â”€ id (uuid, PK)
â”œâ”€â”€ meta_lead_id (varchar, unique)
â”œâ”€â”€ campaign_id (varchar)
â”œâ”€â”€ lead_crm_id (uuid, FK â†’ leads)
â”œâ”€â”€ first_name, last_name, email, phone, company
â”œâ”€â”€ status ('created', 'duplicate', 'error')
â””â”€â”€ timestamps

meta_ads_config
â”œâ”€â”€ id (uuid, PK)
â”œâ”€â”€ business_account_id (varchar, unique)
â”œâ”€â”€ access_token (encrypted)
â”œâ”€â”€ refresh_token (encrypted)
â”œâ”€â”€ pixel_id (varchar)
â””â”€â”€ timestamps

meta_ads_campaigns
â”œâ”€â”€ id (uuid, PK)
â”œâ”€â”€ meta_campaign_id (varchar, unique)
â”œâ”€â”€ campaign_name (varchar)
â””â”€â”€ auto_assign_to (uuid, FK â†’ users)
```

---

## Database Schema: Phase 3 (Google Ads)

```
google_ads_leads
â”œâ”€â”€ id (uuid, PK)
â”œâ”€â”€ google_lead_id (varchar, unique)
â”œâ”€â”€ campaign_id (varchar)
â”œâ”€â”€ lead_crm_id (uuid, FK â†’ leads)
â”œâ”€â”€ first_name, last_name, email, phone, company
â”œâ”€â”€ status ('created', 'duplicate', 'error')
â””â”€â”€ timestamps

google_ads_config
â”œâ”€â”€ id (uuid, PK)
â”œâ”€â”€ customer_id (varchar, unique)
â”œâ”€â”€ access_token (encrypted)
â”œâ”€â”€ refresh_token (encrypted)
â”œâ”€â”€ developer_token (encrypted)
â”œâ”€â”€ campaign_ids[] (array)
â””â”€â”€ timestamps

google_ads_campaigns
â”œâ”€â”€ id (uuid, PK)
â”œâ”€â”€ google_campaign_id (varchar, unique)
â”œâ”€â”€ campaign_name (varchar)
â””â”€â”€ auto_assign_to (uuid)
```

---

## Database Schema: Phase 4 (WhatsApp)

```
whatsapp_conversations
â”œâ”€â”€ id (uuid, PK)
â”œâ”€â”€ contact_id (uuid, FK â†’ contacts)
â”œâ”€â”€ whatsapp_phone (varchar)
â”œâ”€â”€ last_message_at (timestamp)
â”œâ”€â”€ last_message_text (text)
â”œâ”€â”€ unread_count (int)
â””â”€â”€ status ('active', 'archived', 'closed')

whatsapp_messages
â”œâ”€â”€ id (uuid, PK)
â”œâ”€â”€ conversation_id (uuid, FK)
â”œâ”€â”€ whatsapp_message_id (varchar, unique)
â”œâ”€â”€ direction ('inbound', 'outbound')
â”œâ”€â”€ message_type ('text', 'image', 'document', 'audio', 'video')
â”œâ”€â”€ content (text)
â”œâ”€â”€ status ('sent', 'delivered', 'read')
â””â”€â”€ timestamps

whatsapp_config
â”œâ”€â”€ id (uuid, PK)
â”œâ”€â”€ phone_number_id (varchar, unique)
â”œâ”€â”€ access_token (encrypted)
â”œâ”€â”€ webhook_verify_token (varchar)
â””â”€â”€ auto_response_message (text)

whatsapp_templates
â”œâ”€â”€ id (uuid, PK)
â”œâ”€â”€ template_name (varchar)
â”œâ”€â”€ template_content (text)
â”œâ”€â”€ category ('MARKETING', 'OTP', 'UTILITY')
â””â”€â”€ body_variables[] (array)

whatsapp_campaigns
â”œâ”€â”€ id (uuid, PK)
â”œâ”€â”€ campaign_name (varchar)
â”œâ”€â”€ template_id (uuid, FK)
â”œâ”€â”€ recipient_count (int)
â””â”€â”€ status ('draft', 'scheduled', 'in_progress', 'completed')
```

---

## API Endpoints

### Webhook Receivers
```
POST /api/webhooks/meta
POST /api/webhooks/google  
POST /api/webhooks/whatsapp
```

### Internal APIs (via PostgREST)
```
GET    /rest/v1/leads
POST   /rest/v1/leads
PATCH  /rest/v1/leads/:id

GET    /rest/v1/meta_ads_leads
GET    /rest/v1/google_ads_leads
GET    /rest/v1/whatsapp_conversations
GET    /rest/v1/whatsapp_messages
POST   /rest/v1/whatsapp_messages
```

---

## Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. API Level                                              â”‚
â”‚    â”œâ”€ HMAC-SHA256 Signature Verification                 â”‚
â”‚    â”œâ”€ Rate Limiting                                      â”‚
â”‚    â”œâ”€ IP Whitelisting (optional)                         â”‚
â”‚    â””â”€ Timestamp Validation (replay attack prevention)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Authentication Level                                   â”‚
â”‚    â”œâ”€ OAuth 2.0 for Meta Ads & Google Ads               â”‚
â”‚    â”œâ”€ API Token for WhatsApp                            â”‚
â”‚    â”œâ”€ Token Encryption in Database                      â”‚
â”‚    â””â”€ Token Rotation                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Database Level                                         â”‚
â”‚    â”œâ”€ Row-Level Security (RLS) Policies                 â”‚
â”‚    â”œâ”€ Encrypted Fields (api keys, tokens)               â”‚
â”‚    â”œâ”€ Foreign Key Constraints                           â”‚
â”‚    â””â”€ Audit Logging                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Application Level                                      â”‚
â”‚    â”œâ”€ Input Validation (TypeScript types)               â”‚
â”‚    â”œâ”€ Error Handling                                     â”‚
â”‚    â”œâ”€ Logging & Monitoring                              â”‚
â”‚    â””â”€ HTTPS Only                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Performance Optimization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database Optimization                                 â”‚
â”‚ â”œâ”€ Indexes on frequently queried columns            â”‚
â”‚ â”‚  â”œâ”€ webhooks(created_at)                          â”‚
â”‚ â”‚  â”œâ”€ leads(email, phone)                           â”‚
â”‚ â”‚  â”œâ”€ meta_ads_leads(email)                         â”‚
â”‚ â”‚  â”œâ”€ google_ads_leads(email)                       â”‚
â”‚ â”‚  â””â”€ whatsapp_conversations(contact_id, phone)    â”‚
â”‚ â”œâ”€ Pagination for large result sets                 â”‚
â”‚ â”œâ”€ Connection pooling                               â”‚
â”‚ â””â”€ Query optimization                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Optimization                                      â”‚
â”‚ â”œâ”€ Edge Functions for fast webhook processing      â”‚
â”‚ â”œâ”€ Async/await for non-blocking operations         â”‚
â”‚ â”œâ”€ Connection pooling to database                  â”‚
â”‚ â”œâ”€ Caching for frequently accessed data            â”‚
â”‚ â””â”€ Batch processing for bulk operations            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Optimization                                 â”‚
â”‚ â”œâ”€ React.memo for component memoization            â”‚
â”‚ â”œâ”€ useCallback for function memoization            â”‚
â”‚ â”œâ”€ Code splitting with React.lazy                  â”‚
â”‚ â”œâ”€ Lazy loading for large lists                    â”‚
â”‚ â””â”€ Real-time subscriptions (Supabase)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Monitoring & Observability

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Logging                                               â”‚
â”‚ â”œâ”€ Webhook logs (all incoming requests)             â”‚
â”‚ â”œâ”€ Error logs (failures, exceptions)                â”‚
â”‚ â”œâ”€ Activity logs (lead creation, messages)          â”‚
â”‚ â””â”€ Access logs (API calls, user actions)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Metrics                                               â”‚
â”‚ â”œâ”€ Webhook success rate (target: 99%)              â”‚
â”‚ â”œâ”€ Lead capture rate                               â”‚
â”‚ â”œâ”€ API response time (target: < 200ms)            â”‚
â”‚ â”œâ”€ Database query time (target: < 100ms)          â”‚
â”‚ â”œâ”€ Message delivery rate (target: 95%)            â”‚
â”‚ â””â”€ Uptime (target: 99.9%)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Alerts                                                â”‚
â”‚ â”œâ”€ High error rate (> 5%)                          â”‚
â”‚ â”œâ”€ API response time slow (> 500ms)               â”‚
â”‚ â”œâ”€ Database down                                    â”‚
â”‚ â”œâ”€ Token expired                                    â”‚
â”‚ â””â”€ Webhook queue backlog                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Scaling Strategy

```
Phase 1 (0-1000 leads/day)
â”œâ”€ Single Supabase instance
â”œâ”€ Default indexes
â”œâ”€ Standard edge functions
â””â”€ No caching needed

Phase 2 (1000-10,000 leads/day)
â”œâ”€ Add read replicas
â”œâ”€ Optimize indexes
â”œâ”€ Implement caching
â””â”€ Monitor query performance

Phase 3 (10,000-100,000 leads/day)
â”œâ”€ Horizontal scaling (multiple instances)
â”œâ”€ Message queue (for async processing)
â”œâ”€ Redis caching layer
â””â”€ Database partitioning

Phase 4+ (100,000+ leads/day)
â”œâ”€ Multi-region deployment
â”œâ”€ CDN for static assets
â”œâ”€ Dedicated webhook processing service
â””â”€ Separate database for analytics
```

---

**Architecture Version**: 1.0  
**Last Updated**: 2025-12-31  
**Status**: Production Ready âœ…
